<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>シフト表（スタッフ用）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #111;
      line-height: 1.6;
      font-size: 14px;
    }

    .app {
      max-width: 1000px;
      margin: 0 auto;
      padding: 16px 12px 40px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    header h1 {
      font-size: 18px;
      font-weight: 700;
    }

    .meta {
      font-size: 12px;
      color: #666;
    }

    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .controls input[type="date"] {
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
    }

    .controls button {
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      background: #111;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
    }

    .controls button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .card {
      background: #fff;
      border-radius: 6px;
      border: 1px solid #2e7d32; /* 端末っぽく緑の枠 */
      padding: 8px;
      overflow-x: auto;
    }

    /* ============================
       シフト表（ローソン端末風）
       ============================ */

    .shift-week-table {
      width: 100%;
      min-width: 900px;
      border-collapse: collapse;
      table-layout: fixed;
      background: #ffffff;
      font-size: 11px;
    }

    .shift-week-table th,
    .shift-week-table td {
      border: 1px solid #b9d8b9;  /* 薄い緑の罫線 */
      padding: 2px 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .shift-week-table thead th {
      background: #f5fff5;
      color: #215c2f;
      font-weight: 600;
      text-align: center;
      border-bottom: 2px solid #2e7d32;
    }

    /* 左端：スタッフ名列 */
    .shift-week-table td.staff {
      background: #f5fff5;
      font-weight: 600;
      text-align: left;
      width: 110px;
    }

    /* 土日カラー */
    .shift-week-table .is-sat {
      color: #1565c0;   /* 青 */
    }
    .shift-week-table .is-sun {
      color: #c62828;   /* 赤 */
    }

    /* シフトありセル */
    .shift-cell {
      display: block;
      padding: 0 2px;
      border-radius: 2px;
      background: #e8f5e9;
      border: 1px solid #a5d6a7;
      font-weight: 600;
      text-align: center;
    }

    /* シフトなしセル */
    .shift-empty {
      color: #bbb;
      font-size: 11px;
    }

    .notice {
      margin-top: 8px;
      font-size: 11px;
      color: #666;
    }

    .error {
      margin-top: 8px;
      font-size: 12px;
      color: #b00020;
    }

    @media (max-width: 640px) {
      header h1 {
        font-size: 16px;
      }
      .app {
        padding-inline: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>シフト表</h1>
        <div class="meta" id="storeLabel"></div>
      </div>
      <div class="meta" id="weekLabel"></div>
    </header>

    <div class="controls">
      <label>
        週の開始日：
        <input type="date" id="weekStartInput" />
      </label>
      <button id="reloadBtn">読み込み</button>
    </div>

    <div class="card" id="tableCard" style="display:none;">
      <!-- ★ class を追加 -->
      <table class="shift-week-table">
        <thead>
          <tr id="theadRow">
            <!-- スタッフ / 月 / 火 ... をJSで -->
          </tr>
        </thead>
        <tbody id="tbody">
          <!-- 各スタッフの行をJSで -->
        </tbody>
      </table>
      <div class="notice">
        ※ オーナー画面「シフト作成（手動）」で保存した内容が表示されます。
      </div>
    </div>

    <div class="error" id="errorBox" style="display:none;"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // =============================
    // Firebase 設定
    // =============================
    const firebaseConfig = {
      apiKey: "AIzaSyAPBMvTpzKCcPxLETncBqVR8fzf0cqKirc",
      authDomain: "lawson-workflow.firebaseapp.com",
      projectId: "lawson-workflow",
      storageBucket: "lawson-workflow.firebasestorage.app",
      messagingSenderId: "335371795694",
      appId: "1:335371795694:web:3b0950a616d368b284c7ff",
      measurementId: "G-BGENZNZMRC"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // =============================
    // ユーティリティ
    // =============================
    function getQueryParam(name) {
      const params = new URLSearchParams(location.search);
      return params.get(name) || "";
    }

    function formatDateLabel(iso) {
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      const m = d.getMonth() + 1;
      const day = d.getDate();
      const w = ["日","月","火","水","木","金","土"][d.getDay()];
      return `${m}/${day} (${w})`;
    }

    function addDays(iso, add) {
      const d = new Date(iso);
      d.setDate(d.getDate() + add);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    // =============================
    // メイン処理
    // =============================
    document.addEventListener("DOMContentLoaded", () => {
      const storeId = getQueryParam("store");
      const storeLabel = document.getElementById("storeLabel");
      const weekLabel = document.getElementById("weekLabel");
      const weekStartInput = document.getElementById("weekStartInput");
      const reloadBtn = document.getElementById("reloadBtn");
      const errorBox = document.getElementById("errorBox");
      const tableCard = document.getElementById("tableCard");
      const theadRow = document.getElementById("theadRow");
      const tbody = document.getElementById("tbody");

      if (!storeId) {
        errorBox.style.display = "block";
        errorBox.textContent = "URLに ?store=店舗ID を付けてアクセスしてください。";
        reloadBtn.disabled = true;
        return;
      }

      storeLabel.textContent = `店舗ID: ${storeId}`;

      // 初期値：今日を含む週の月曜日を weekStart にする
      const today = new Date();
      const dow = today.getDay(); // 0=日
      const diffToMon = (dow + 6) % 7; // 月=0
      today.setDate(today.getDate() - diffToMon);
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, "0");
      const d = String(today.getDate()).padStart(2, "0");
      const defaultWeek = `${y}-${m}-${d}`;
      weekStartInput.value = defaultWeek;

      reloadBtn.addEventListener("click", () => {
        const weekStart = weekStartInput.value;
        if (!weekStart) {
          alert("週の開始日を選択してください。");
          return;
        }
        loadWeek(storeId, weekStart);
      });

      async function loadWeek(storeId, weekStart) {
        errorBox.style.display = "none";
        tableCard.style.display = "none";
        reloadBtn.disabled = true;
        reloadBtn.textContent = "読み込み中…";

        try {
          const docSnap = await db
            .collection("stores")
            .doc(storeId)
            .collection("shiftWeeks")
            .doc(weekStart)
            .get();

          if (!docSnap.exists) {
            throw new Error("この週のシフトはまだ登録されていません。");
          }

          const data = docSnap.data() || {};
          renderTable(data, weekStart);
        } catch (err) {
          console.error(err);
          errorBox.style.display = "block";
          errorBox.textContent = err.message || "シフトの読み込みに失敗しました。";
        } finally {
          reloadBtn.disabled = false;
          reloadBtn.textContent = "読み込み";
        }
      }

      function renderTable(data, weekStart) {
        const members = data.members || [];
        if (!members.length) {
          throw new Error("この週のシフトデータにスタッフが登録されていません。");
        }

        // ヘッダー行を作成
        theadRow.innerHTML = "";
        const thStaff = document.createElement("th");
        thStaff.textContent = "スタッフ";
        theadRow.appendChild(thStaff);

        const dayKeys = [];
        for (let i = 0; i < 7; i++) {
          const dayIso = addDays(weekStart, i);
          dayKeys.push(dayIso);
          const th = document.createElement("th");
          th.textContent = formatDateLabel(dayIso);

          const w = new Date(dayIso).getDay();
          if (w === 6) th.classList.add("is-sat");
          if (w === 0) th.classList.add("is-sun");

          theadRow.appendChild(th);
        }

        weekLabel.textContent = `${formatDateLabel(dayKeys[0])} 〜 ${formatDateLabel(dayKeys[6])}`;

        // 本体
        tbody.innerHTML = "";
        members.forEach((m) => {
          const tr = document.createElement("tr");

          const tdName = document.createElement("td");
          tdName.className = "staff";
          tdName.textContent = m.name || "(名前未設定)";
          tr.appendChild(tdName);

          dayKeys.forEach((dayIso) => {
            const td = document.createElement("td");

            const w = new Date(dayIso).getDay();
            if (w === 6) td.classList.add("is-sat");
            if (w === 0) td.classList.add("is-sun");

            const dayInfo =
              (m.days && m.days[dayIso]) ||
              (m.days && m.days[dayIso.replace(/-/g, "/")]) ||
              null;

            if (dayInfo && dayInfo.start && dayInfo.end) {
              const span = document.createElement("span");
              span.className = "shift-cell";
              span.textContent = `${dayInfo.start}〜${dayInfo.end}`;
              td.appendChild(span);
            } else {
              const span = document.createElement("span");
              span.className = "shift-empty";
              span.textContent = "ーー";
              td.appendChild(span);
            }

            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });

        tableCard.style.display = "block";
      }

      // 初回自動読み込み
      loadWeek(storeId, weekStartInput.value);
    });
  </script>
</body>
</html>
