<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Shiftask Pro æ–°è¦ç™»éŒ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #111;
      line-height: 1.6;
    }

    .page-wrap {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 12px;
    }

    .card {
      width: 100%;
      max-width: 420px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.08);
      padding: 24px 22px 20px;
    }

    .title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .sub {
      font-size: 12px;
      color: #666;
      margin-bottom: 16px;
    }

    .field {
      margin-bottom: 14px;
    }
    label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
    }
    input[type="text"],
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 13px;
      outline: none;
    }
    input:focus {
      border-color: #111;
    }

    .hint {
      font-size: 11px;
      color: #777;
      margin-top: 4px;
    }

    .btn-row {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .btn-primary {
      flex: 1;
      border: none;
      border-radius: 999px;
      padding: 9px 16px;
      font-size: 13px;
      font-weight: 600;
      background: #111;
      color: #fff;
      cursor: pointer;
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .status {
      margin-top: 10px;
      font-size: 12px;
      min-height: 1.2em;
    }
    .status.ok {
      color: #0a7b34;
    }
    .status.err {
      color: #c00;
    }

    .back-link {
      margin-top: 16px;
      font-size: 12px;
      text-align: right;
    }
    .back-link a {
      color: #111;
      text-decoration: none;
      border-bottom: 1px solid #111;
      padding-bottom: 1px;
    }
  </style>
</head>
<body>
  <div class="page-wrap">
    <div class="card">
      <h1 class="title">Shiftask Pro æ–°è¦ç™»éŒ²</h1>
      <p class="sub">
        1åº—èˆ—ã”ã¨ã«ã€Œåº—èˆ—IDã€ã‚’1ã¤ç™»éŒ²ã—ã¾ã™ã€‚<br>
        ç™»éŒ²ãŒå®Œäº†ã—ãŸã‚‰ã€ç®¡ç†ç”»é¢ï¼ˆowner.htmlï¼‰ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚
      </p>

      <div class="field">
        <label for="signupStoreId">åº—èˆ—IDï¼ˆè‹±æ•°å­—ãƒ»3ã€œ30æ–‡å­—ï¼‰</label>
        <input
          id="signupStoreId"
          type="text"
          placeholder="ä¾‹ï¼šnambucho"
          autocomplete="off"
        />
        <p class="hint">
          ãƒ­ãƒ¼ãƒå­—ã®åº—èˆ—åãªã©ãŒãŠã™ã™ã‚ã§ã™ã€‚<br>
          ä¾‹ï¼‰<code>nambucho</code> / <code>lawson_001</code> ãªã©
        </p>
      </div>

      <div class="field">
        <label for="signupEmail">ã‚ªãƒ¼ãƒŠãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰</label>
        <input
          id="signupEmail"
          type="email"
          placeholder="ä¾‹ï¼šowner@example.com"
          autocomplete="email"
        />
        <p class="hint">
          å°†æ¥ã®ãŠçŸ¥ã‚‰ã›ãƒ¡ãƒ¼ãƒ«é€ä¿¡ç”¨ã€‚ä»Šã¯ç©ºã§ã‚‚OKã§ã™ã€‚
        </p>
      </div>

      <div class="field">
        <label for="signupOwnerPass">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input
          id="signupOwnerPass"
          type="password"
          placeholder="ç®¡ç†è€…ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
        />
        <p class="hint">
          ã‚ªãƒ¼ãƒŠãƒ¼ç”¨ç®¡ç†ç”»é¢ï¼ˆowner.htmlï¼‰ã§ä½¿ã†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã™ã€‚
        </p>
      </div>

      <div class="field">
        <label for="signupStaffPass">ã‚¹ã‚¿ãƒƒãƒ•ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input
          id="signupStaffPass"
          type="password"
          placeholder="ã‚¹ã‚¿ãƒƒãƒ•ç”»é¢ç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
        />
        <p class="hint">
          ã‚¹ã‚¿ãƒƒãƒ•ç”¨ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç”»é¢ï¼ˆindex.htmlï¼‰ã®ãƒ­ã‚°ã‚¤ãƒ³ã«ä½¿ã„ã¾ã™ã€‚
        </p>
      </div>

      <div class="btn-row">
        <button id="signupSubmitBtn" class="btn-primary" type="button">
          ğŸŒŸ ã“ã®å†…å®¹ã§ç™»éŒ²ã™ã‚‹
        </button>
      </div>

      <p id="signupStatus" class="status"></p>

      <div class="back-link">
        <a href="owner.html">â† ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹</a>
      </div>
    </div>
  </div>

  <!-- Firebase v8ï¼ˆowner.html ã¨åŒã˜ã§OKï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // =============================
    // Firebase è¨­å®šï¼ˆowner.html ã¨åŒã˜ï¼‰
    // =============================
    const firebaseConfig = {
      apiKey: "AIzaSyAPBMvTpzKCcPxLETncBqVR8fzf0cqKirc",
      authDomain: "lawson-workflow.firebaseapp.com",
      projectId: "lawson-workflow",
      storageBucket: "lawson-workflow.firebasestorage.app",
      messagingSenderId: "335371795694",
      appId: "1:335371795694:web:3b0950a616d368b284c7ff",
      measurementId: "G-BGENZNZMRC"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    function validateStoreId(id) {
      if (!id) return "åº—èˆ—IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
      if (id.length < 3 || id.length > 30) {
        return "åº—èˆ—IDã¯3ã€œ30æ–‡å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
      }
      if (!/^[a-zA-Z0-9_-]+$/.test(id)) {
        return "åº—èˆ—IDã¯è‹±æ•°å­—ã¨ - _ ã ã‘ãŒä½¿ãˆã¾ã™ã€‚";
      }
      return null;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const storeIdInput   = document.getElementById("signupStoreId");
      const emailInput     = document.getElementById("signupEmail");
      const ownerPassInput = document.getElementById("signupOwnerPass");
      const staffPassInput = document.getElementById("signupStaffPass");
      const submitBtn      = document.getElementById("signupSubmitBtn");
      const statusEl       = document.getElementById("signupStatus");

      async function handleSignup() {
        const storeId   = (storeIdInput.value || "").trim();
        const email     = (emailInput.value || "").trim();
        const ownerPass = (ownerPassInput.value || "").trim();
        const staffPass = (staffPassInput.value || "").trim();

        // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
        const idError = validateStoreId(storeId);
        if (idError) {
          statusEl.textContent = idError;
          statusEl.className = "status err";
          return;
        }
        // ãƒ¡ãƒ¼ãƒ«ã¯ä»»æ„ï¼ˆç©ºã§ã‚‚OKï¼‰
        if (!ownerPass) {
          statusEl.textContent = "ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
          statusEl.className = "status err";
          return;
        }
        if (!staffPass) {
          statusEl.textContent = "ã‚¹ã‚¿ãƒƒãƒ•ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
          statusEl.className = "status err";
          return;
        }

        submitBtn.disabled = true;
        statusEl.textContent = "ç™»éŒ²ä¸­ã§ã™â€¦";
        statusEl.className = "status";

        try {
          const storeDocRef = db.collection("stores").doc(storeId);
          const snap = await storeDocRef.get();

          if (snap.exists) {
            statusEl.textContent = "ã“ã®åº—èˆ—IDã¯ã™ã§ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
            statusEl.className = "status err";
            submitBtn.disabled = false;
            return;
          }

          // stores/{storeId} æœ¬ä½“
          await storeDocRef.set({
            storeId,
            email: email || null,
            ownerPassword: ownerPass,
            staffPassword: staffPass,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            plan: "trial",
            isActive: true
          });

          // settings/auth ã«ã‚‚ä¿å­˜
          await storeDocRef
            .collection("settings")
            .doc("auth")
            .set({
              ownerPassword: ownerPass,
              staffPassword: staffPass,
              email: email || null,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

          // â˜… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã¨ãã ã‘ã€ãŠç¤¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚‹
if (email) {
  try {
    await fetch(
      "https://sendsignupmail-tzkim55q4a-uc.a.run.app",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ storeId, email })
      }
    );
  } catch (mailErr) {
    console.warn(
      "ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ç™»éŒ²è‡ªä½“ã¯å®Œäº†ã—ã¦ã„ã¾ã™:",
      mailErr
    );
  }
}


          statusEl.textContent =
            "ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã£ã¦ã€åº—èˆ—IDã¨ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚";
          statusEl.className = "status ok";

          ownerPassInput.value = "";
          staffPassInput.value = "";

          setTimeout(() => {
            window.location.href = "owner.html";
          }, 3000);

        } catch (err) {
          console.error("ç™»éŒ²ã‚¨ãƒ©ãƒ¼", err);
          statusEl.textContent = "ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
          statusEl.className = "status err";
          submitBtn.disabled = false;
          return;
        }
      }

      if (submitBtn) {
        submitBtn.addEventListener("click", handleSignup);
      }

      [storeIdInput, emailInput, ownerPassInput, staffPassInput].forEach((el) => {
        if (!el) return;
        el.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            handleSignup();
          }
        });
      });
    });
  </script>
</body>
</html>
