<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>シフト表（スタッフ用）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #f5f5f5;
    color: #111;
    line-height: 1.6;
    font-size: 14px;
  }

  .app {
    max-width: 1300px;
    margin: 0 auto;
    padding: 16px 12px 40px;
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  header h1 {
    font-size: 18px;
    font-weight: 700;
  }

  .meta {
    font-size: 12px;
    color: #666;
  }

  .controls {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 8px;
    flex-wrap: wrap;
  }

  .controls input[type="date"] {
    padding: 4px 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #fff;
    font-size: 13px;
  }

  .controls button {
    padding: 6px 10px;
    border-radius: 999px;
    border: none;
    background: #111;
    color: #fff;
    font-size: 12px;
    cursor: pointer;
  }

  .controls button:disabled {
    opacity: 0.4;
    cursor: default;
  }

  .card {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(15, 23, 42, 0.05);
    padding: 10px 10px 12px;
    overflow-x: auto;  /* 画面が狭いPCだけ横スクロール */
  }

  .card h2 {
    font-size: 15px;
    margin-bottom: 4px;
  }

  .card-sub {
    font-size: 12px;
    color: #555;
    margin-bottom: 8px;
  }

  .hint {
    font-size: 11px;
    color: #666;
  }

  .error {
    margin-top: 8px;
    font-size: 12px;
    color: #b00020;
  }

  /* ========== シフト表ツールバー ========== */

  .shiftboard-toolbar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 8px 0 10px;
    font-size: 12px;
  }

  .shiftboard-week-control {
    display: flex;
    gap: 4px;
  }

  .shiftboard-week-control button {
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid #ddd;
    background: #f9fafb;
    font-size: 11px;
    cursor: pointer;
  }

  .shiftboard-week-control button:hover {
    background: #fff;
  }

  .shiftboard-meta {
    font-size: 12px;
    color: #555;
  }

  .shiftboard-actions {
    margin-left: auto;
  }

  .shiftboard-actions button {
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #ddd;
    background: #f9fafb;
    font-size: 11px;
    cursor: pointer;
  }

  .shiftboard-actions button:hover {
    background: #fff;
  }

  /* ========== シフト表 本体 ========== */

  .shiftboard-shell {
    border: 1px solid #e2e2e2;
    border-radius: 8px;
    background: #fff;
    box-shadow: 0 2px 6px rgba(15, 23, 42, 0.03);
  }

  .shiftboard-table {
    width: 100%;              /* PCでは1画面に収める想定 */
    min-width: 960px;         /* あまり潰れないように */
    border-collapse: collapse;
    table-layout: fixed;
    font-size: 11px;
  }

  .shiftboard-table thead {
    background: linear-gradient(to bottom, #fafafa, #f3f4f6);
  }

  .shiftboard-table th,
  .shiftboard-table td {
    border: 1px solid #e5e7eb;   /* 全マスに線を出す（グリッド） */
    padding: 4px 3px;
    text-align: center;
    background: transparent;
  }

  .shiftboard-col-date {
    width: 78px;
    background: #fafafa;
    font-weight: 600;
    vertical-align: top;
  }

  .shiftboard-date-main {
    font-size: 12px;
  }

  .shiftboard-date-week {
    font-size: 11px;
    color: #555;
  }

  .shiftboard-date-week.sat {
    color: #2563eb;
  }

  .shiftboard-date-week.sun {
    color: #ef4444;
  }

  .shiftboard-col-hour {
    width: 30px;
    font-weight: 500;
    color: #4b5563;
  }

  .shiftboard-col-mh,
  .shiftboard-col-people {
    width: 60px;
    background: #fafafa;
    font-weight: 600;
  }

  .shiftboard-empty {
    background: transparent;   /* 空欄もグリッドだけ見せる */
  }

  .shiftboard-bar-cell {
    padding: 0;
    background: transparent;
    height: 34px;              /* 行少し高め */
  }

  /* ★ 背景のマス目（時間の列だけ全部に出す） */
.shiftboard-table tbody td.shiftboard-bar-cell,
.shiftboard-table tbody td.shiftboard-empty {
  background-image: repeating-linear-gradient(
    to right,
    #f3f4f6 0px,
    #f3f4f6 1px,
    transparent 1px,
    transparent 32px   /* 1時間の幅。必要ならここだけ微調整でOK */
  );
  background-size: 32px 100%;
}



  /* ========== 棒（シフトバー） ========== */

  .shiftboard-bar {
    height: 26px;
    margin: 1px;
    border-radius: 999px;
    background: linear-gradient(90deg, #eef2ff, #e0f2fe);
    border: 1px solid rgba(129, 140, 248, 0.45);
    display: flex;
    flex-direction: column;      /* 名前↑ 時間↓ の縦並び */
    align-items: center;
    justify-content: center;
    gap: 2px;
    padding: 0 10px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
    font-size: 11px;
  }

  .shiftboard-bar-name {
    display: block;
    font-weight: 600;
    line-height: 1.1;
    color: #111827;
  }

  .shiftboard-bar-time {
    display: block;
    font-size: 10px;
    line-height: 1.1;
    color: #4b5563;
  }

  @media (max-width: 640px) {
    header h1 {
      font-size: 16px;
    }
    .app {
      padding-inline: 8px;
    }
  }

  /* ========== 印刷用レイアウト ========== */
  @media print {
    body {
      background: #fff;
      font-size: 11px;
    }

    .app {
      max-width: none;   /* 用紙いっぱい使う */
      margin: 0;
      padding: 0;
    }

    .card {
      box-shadow: none;
      border-radius: 0;
      overflow: visible;
    }

    .shiftboard-shell {
      box-shadow: none;
      border-radius: 0;
    }

    .shiftboard-table {
      width: 100%;
      min-width: 0;
    }

    .shiftboard-bar {
      height: 22px;
      padding: 0 6px;
      font-size: 10px;  /* 少しだけ縮めて詰める */
    }
  }
</style>

</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>シフト表</h1>
        <div class="meta" id="storeLabel"></div>
      </div>
      <div class="meta" id="weekLabel"></div>
    </header>

    <div class="controls">
      <label>
        週の開始日：
        <input type="date" id="weekStartInput" />
      </label>
      <button id="reloadBtn">読み込み</button>
    </div>

    <section class="card" id="shiftCard" style="display:none;">
      <h2>1週間シフト（予定表スタイル）</h2>
      <p class="card-sub">
        オーナー画面「シフト作成（手動）」で登録した内容を、
        ローソン端末のような横棒シフト表で表示します。
      </p>

      <div class="shiftboard-toolbar">
        <div class="shiftboard-week-control">
          <button type="button" id="prevWeekBtn">◀ 先週</button>
          <button type="button" id="thisWeekBtn">今週</button>
          <button type="button" id="nextWeekBtn">翌週 ▶</button>
        </div>
        <div class="shiftboard-meta">
          対象週：<span id="shiftWeekRangeLabel"></span>
        </div>
        <div class="shiftboard-actions">
          <button type="button" id="printBtn">印刷</button>
        </div>
      </div>

      <div class="shiftboard-shell">
        <table class="shiftboard-table">
          <thead>
            <tr>
              <th class="shiftboard-col-date">勤務日付</th>
              <!-- 6〜23, 0〜5 -->
              <th class="shiftboard-col-hour">6</th>
              <th class="shiftboard-col-hour">7</th>
              <th class="shiftboard-col-hour">8</th>
              <th class="shiftboard-col-hour">9</th>
              <th class="shiftboard-col-hour">10</th>
              <th class="shiftboard-col-hour">11</th>
              <th class="shiftboard-col-hour">12</th>
              <th class="shiftboard-col-hour">13</th>
              <th class="shiftboard-col-hour">14</th>
              <th class="shiftboard-col-hour">15</th>
              <th class="shiftboard-col-hour">16</th>
              <th class="shiftboard-col-hour">17</th>
              <th class="shiftboard-col-hour">18</th>
              <th class="shiftboard-col-hour">19</th>
              <th class="shiftboard-col-hour">20</th>
              <th class="shiftboard-col-hour">21</th>
              <th class="shiftboard-col-hour">22</th>
              <th class="shiftboard-col-hour">23</th>
              <th class="shiftboard-col-hour">0</th>
              <th class="shiftboard-col-hour">1</th>
              <th class="shiftboard-col-hour">2</th>
              <th class="shiftboard-col-hour">3</th>
              <th class="shiftboard-col-hour">4</th>
              <th class="shiftboard-col-hour">5</th>
              <th class="shiftboard-col-mh">M/H</th>
              <th class="shiftboard-col-people">複員人数</th>
            </tr>
          </thead>
          <tbody id="shiftboardBody">
            <!-- JSで行を描画 -->
          </tbody>
        </table>
      </div>

      <p class="hint" style="margin-top:8px;">
        ※ 横の時間軸は「6〜23時 → 0〜5時」の順になっています（ローソン端末と同じイメージ）。<br>
        ※ 夜勤帯（22:00〜翌5:00など）は、日付またぎでも横棒がつながるように表示します。
      </p>
    </section>

    <div class="error" id="errorBox" style="display:none;"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // =============================
    // Firebase 設定
    // =============================
    const firebaseConfig = {
      apiKey: "AIzaSyAPBMvTpzKCcPxLETncBqVR8fzf0cqKirc",
      authDomain: "lawson-workflow.firebaseapp.com",
      projectId: "lawson-workflow",
      storageBucket: "lawson-workflow.firebasestorage.app",
      messagingSenderId: "335371795694",
      appId: "1:335371795694:web:3b0950a616d368b284c7ff",
      measurementId: "G-BGENZNZMRC"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // =============================
    // ユーティリティ
    // =============================
    function getQueryParam(name) {
      const params = new URLSearchParams(location.search);
      return params.get(name) || "";
    }

    function addDays(iso, add) {
      const d = new Date(iso);
      d.setDate(d.getDate() + add);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate(), 10).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function formatDateShort(iso) {
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      const m = d.getMonth() + 1;
      const day = d.getDate();
      return `${m}/${day}`;
    }

    function getWeekday(d) {
      const labels = ["日","月","火","水","木","金","土"];
      return labels[d.getDay()] || "";
    }

    function timeStrToMin(str) {
      if (!str) return null;
      const [h, m] = str.split(":").map(n => parseInt(n, 10));
      if (Number.isNaN(h) || Number.isNaN(m)) return null;
      return h * 60 + m;
    }

    // 6〜23,0〜5 の並び（ローソン端末風）
    const DISPLAY_HOURS = [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,0,1,2,3,4,5];
    const HOUR_TO_INDEX = {};
    DISPLAY_HOURS.forEach((h, i) => { HOUR_TO_INDEX[h] = i; });
    const TOTAL_COLS = DISPLAY_HOURS.length; // 24

    function calcBarRange(startMin, endMin) {
      if (startMin == null || endMin == null || endMin <= startMin) return null;

      // 0〜24h の範囲で扱う（跨ぎにも一応対応）
      const startHour = Math.floor(startMin / 60);
      const endHour = Math.ceil(endMin / 60);

      const indices = [];
      for (let h = startHour; h < endHour; h++) {
        const hMod = ((h % 24) + 24) % 24;
        const idx = HOUR_TO_INDEX[hMod];
        if (idx != null) indices.push(idx);
      }
      if (!indices.length) return null;

      indices.sort((a, b) => a - b);
      const startIndex = indices[0];
      const endIndex = indices[indices.length - 1] + 1;
      return {
        startIndex,
        span: Math.max(1, endIndex - startIndex)
      };
    }

    function createDateCellContent(iso) {
      const d = new Date(iso);
      if (isNaN(d.getTime())) {
        return { html: `<div class="shiftboard-date-main">${iso}</div>`, wclass: "" };
      }
      const label = formatDateShort(iso);
      const w = getWeekday(d);
      const wd = d.getDay();
      let wclass = "";
      if (wd === 0) wclass = "sun";
      else if (wd === 6) wclass = "sat";
      const html = `
        <div class="shiftboard-date-main">${label}</div>
        <div class="shiftboard-date-week ${wclass}">${w}</div>
      `;
      return { html, wclass };
    }

    // =============================
    // メイン処理
    // =============================
    document.addEventListener("DOMContentLoaded", () => {
      const storeId = getQueryParam("store");
      const storeLabel = document.getElementById("storeLabel");
      const weekLabel = document.getElementById("weekLabel");
      const weekStartInput = document.getElementById("weekStartInput");
      const reloadBtn = document.getElementById("reloadBtn");
      const errorBox = document.getElementById("errorBox");
      const shiftCard = document.getElementById("shiftCard");
      const shiftWeekRangeLabel = document.getElementById("shiftWeekRangeLabel");
      const tbody = document.getElementById("shiftboardBody");
      const prevWeekBtn = document.getElementById("prevWeekBtn");
      const nextWeekBtn = document.getElementById("nextWeekBtn");
      const thisWeekBtn = document.getElementById("thisWeekBtn");
      const printBtn = document.getElementById("printBtn");

      if (!storeId) {
        errorBox.style.display = "block";
        errorBox.textContent = "URLに ?store=店舗ID を付けてアクセスしてください。";
        reloadBtn.disabled = true;
        return;
      }

      storeLabel.textContent = `店舗ID: ${storeId}`;

      // 初期値：今日を含む週の月曜
      const today = new Date();
      const dow = today.getDay(); // 0=日
      const diffToMon = (dow + 6) % 7; // 月=0
      today.setDate(today.getDate() - diffToMon);
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, "0");
      const d = String(today.getDate(), 10).padStart(2, "0");
      const defaultWeek = `${y}-${m}-${d}`;
      weekStartInput.value = defaultWeek;

      function updateWeekLabels(weekStartIso) {
        const firstIso = addDays(weekStartIso, 0);
        const lastIso  = addDays(weekStartIso, 6);
        weekLabel.textContent =
          `${formatDateShort(firstIso)}〜${formatDateShort(lastIso)}`;
        shiftWeekRangeLabel.textContent =
          `${formatDateShort(firstIso)}〜${formatDateShort(lastIso)}`;
      }

      async function loadWeek(storeId, weekStart) {
        errorBox.style.display = "none";
        shiftCard.style.display = "none";
        reloadBtn.disabled = true;
        reloadBtn.textContent = "読み込み中…";

        try {
          const snap = await db
            .collection("stores")
            .doc(storeId)
            .collection("shiftWeeks")
            .doc(weekStart)
            .get();

          if (!snap.exists) {
            throw new Error("この週のシフトはまだ登録されていません。");
          }

          const data = snap.data() || {};
          renderBoard(data, weekStart);
          updateWeekLabels(weekStart);
          shiftCard.style.display = "block";
        } catch (err) {
          console.error(err);
          errorBox.style.display = "block";
          errorBox.textContent = err.message || "シフトの読み込みに失敗しました。";
        } finally {
          reloadBtn.disabled = false;
          reloadBtn.textContent = "読み込み";
        }
      }

      function renderBoard(data, weekStart) {
        const members = data.members || [];
        tbody.innerHTML = "";

        const dayIsos = [];
        for (let i = 0; i < 7; i++) {
          dayIsos.push(addDays(weekStart, i));
        }

        dayIsos.forEach(dayIso => {
          const shifts = [];
          let totalMinutes = 0;

          members.forEach(m => {
            const dayInfo =
              (m.days && m.days[dayIso]) ||
              (m.days && m.days[dayIso.replace(/-/g, "/")]) ||
              null;

            if (!dayInfo || !dayInfo.start || !dayInfo.end) return;

            const startMin = timeStrToMin(dayInfo.start);
            const endMin   = timeStrToMin(dayInfo.end);
            if (startMin == null || endMin == null || endMin <= startMin) return;

            const range = calcBarRange(startMin, endMin);
            if (!range) return;

            totalMinutes += (endMin - startMin);

            shifts.push({
              name: m.name || "スタッフ",
              startTime: dayInfo.start,
              endTime: dayInfo.end,
              startIndex: range.startIndex,
              span: range.span
            });
          });

          const rowCount = Math.max(1, shifts.length);
          const { html: dateHtml } = createDateCellContent(dayIso);
          const peopleCount = shifts.length;
          const mhHours = Math.floor(totalMinutes / 60);
          const mhMin   = totalMinutes % 60;
          const mhLabel = totalMinutes
            ? `${mhHours}:${String(mhMin).padStart(2, "0")}`
            : "-";

          if (!shifts.length) {
            // シフトなしの日：空行1本
            const tr = document.createElement("tr");

            const tdDate = document.createElement("td");
            tdDate.className = "shiftboard-col-date";
            tdDate.innerHTML = dateHtml;
            tr.appendChild(tdDate);

            const tdEmpty = document.createElement("td");
            tdEmpty.className = "shiftboard-empty";
            tdEmpty.colSpan = TOTAL_COLS;
            tr.appendChild(tdEmpty);

            const tdMh = document.createElement("td");
            tdMh.className = "shiftboard-col-mh";
            tdMh.textContent = "-";
            tr.appendChild(tdMh);

            const tdPeople = document.createElement("td");
            tdPeople.className = "shiftboard-col-people";
            tdPeople.textContent = "0";
            tr.appendChild(tdPeople);

            tbody.appendChild(tr);
            return;
          }

          shifts.forEach((shift, idx) => {
            const tr = document.createElement("tr");

            if (idx === 0) {
              const tdDate = document.createElement("td");
              tdDate.className = "shiftboard-col-date";
              tdDate.rowSpan = rowCount;
              tdDate.innerHTML = dateHtml;
              tr.appendChild(tdDate);
            }

            // 空き → バー → 空き の3セルで 24時間を表現
            const before = Math.max(0, shift.startIndex);
            const barSpan = Math.max(1, shift.span);
            const after = Math.max(0, TOTAL_COLS - before - barSpan);

            if (before > 0) {
              const tdBefore = document.createElement("td");
              tdBefore.className = "shiftboard-empty";
              tdBefore.colSpan = before;
              tr.appendChild(tdBefore);
            }

            const tdBar = document.createElement("td");
            tdBar.className = "shiftboard-bar-cell";
            tdBar.colSpan = barSpan;
            const barDiv = document.createElement("div");
            barDiv.className = "shiftboard-bar";
            const nameSpan = document.createElement("span");
            nameSpan.className = "shiftboard-bar-name";
            nameSpan.textContent = shift.name;
            const timeSpan = document.createElement("span");
            timeSpan.className = "shiftboard-bar-time";
            timeSpan.textContent = `${shift.startTime}〜${shift.endTime}`;
            barDiv.appendChild(nameSpan);
            barDiv.appendChild(timeSpan);
            tdBar.appendChild(barDiv);
            tr.appendChild(tdBar);

            if (after > 0) {
              const tdAfter = document.createElement("td");
              tdAfter.className = "shiftboard-empty";
              tdAfter.colSpan = after;
              tr.appendChild(tdAfter);
            }

            if (idx === 0) {
              const tdMh = document.createElement("td");
              tdMh.className = "shiftboard-col-mh";
              tdMh.rowSpan = rowCount;
              tdMh.textContent = mhLabel;
              tr.appendChild(tdMh);

              const tdPeople = document.createElement("td");
              tdPeople.className = "shiftboard-col-people";
              tdPeople.rowSpan = rowCount;
              tdPeople.textContent = String(peopleCount);
              tr.appendChild(tdPeople);
            }

            tbody.appendChild(tr);
          });
        });
      }

      // イベント
      reloadBtn.addEventListener("click", () => {
        const weekStart = weekStartInput.value;
        if (!weekStart) {
          alert("週の開始日を選択してください。");
          return;
        }
        loadWeek(storeId, weekStart);
      });

      prevWeekBtn.addEventListener("click", () => {
        const base = weekStartInput.value || defaultWeek;
        const prev = addDays(base, -7);
        weekStartInput.value = prev;
        loadWeek(storeId, prev);
      });

      nextWeekBtn.addEventListener("click", () => {
        const base = weekStartInput.value || defaultWeek;
        const next = addDays(base, 7);
        weekStartInput.value = next;
        loadWeek(storeId, next);
      });

      thisWeekBtn.addEventListener("click", () => {
        weekStartInput.value = defaultWeek;
        loadWeek(storeId, defaultWeek);
      });

      printBtn.addEventListener("click", () => {
        window.print();
      });

      // 初回ロード
      loadWeek(storeId, weekStartInput.value);
    });
  </script>
</body>
</html>
