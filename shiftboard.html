<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>シフト表（スタッフ用）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f6f8;
      color: #111;
      line-height: 1.6;
      font-size: 14px;
    }

    .app {
      max-width: 1300px;
      margin: 0 auto;
      padding: 16px 12px 40px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 12px;
      margin-bottom: 10px;
    }
    header h1 {
      font-size: 18px;
      font-weight: 800;
    }
    .meta {
      font-size: 12px;
      color: #666;
    }

    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin: 10px 0 14px;
    }
    .btn {
      border: 1px solid #ddd;
      background: #fff;
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
    }
    .btn:active { transform: translateY(1px); }
    .btn.primary {
      border-color: #c7d2fe;
      background: #eef2ff;
    }
    .pill {
      padding: 7px 10px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid #ddd;
      font-size: 12px;
      color: #444;
    }

    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
    }

    .table-wrap {
      overflow: auto;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      background: #fff;
    }

    table.shiftboard {
      border-collapse: collapse;
      min-width: 980px;
      width: 100%;
    }
    table.shiftboard th, table.shiftboard td {
      border: 1px solid #eef0f3;
      padding: 6px;
      text-align: center;
      white-space: nowrap;
    }

    /* 左端（日付 / 曜日） */
    .shiftboard-day {
      position: sticky;
      left: 0;
      background: #fff;
      z-index: 2;
      min-width: 130px;
      text-align: left !important;
      padding-left: 10px !important;
      font-weight: 800;
    }
    .shiftboard-day small { display: block; font-weight: 600; color: #666; }

    /* ヘッダー行 */
    thead th {
      position: sticky;
      top: 0;
      z-index: 3;
      background: #fafafa;
      font-size: 12px;
      color: #444;
    }
    thead th.shiftboard-day { z-index: 4; }

    .shiftboard-empty {
      background: #fff;
    }

    .shiftboard-bar-cell {
      padding: 4px !important;
      background: #fff;
    }
    .shiftboard-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      background: #111827;
      color: #fff;
      font-weight: 800;
      font-size: 12px;
    }
    .shiftboard-bar-name {
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
    }
    .shiftboard-bar-time {
      font-weight: 700;
      color: rgba(255,255,255,.85);
      font-size: 11px;
    }

    .notice {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }
    .error {
      color: #b91c1c;
      font-weight: 800;
      margin-top: 10px;
      white-space: pre-wrap;
    }
  </style>

  <!-- Firebase SDK（compat） -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
</head>

<body>
  <div class="app">
    <header>
      <div>
        <h1>シフト表</h1>
        <div class="meta" id="metaText">読み込み中...</div>
      </div>
      <div class="controls">
        <button class="btn" id="prevBtn">◀ 前の週</button>
        <button class="btn primary" id="thisBtn">今週</button>
        <button class="btn" id="nextBtn">次の週 ▶</button>
        <span class="pill" id="weekLabel">----</span>
      </div>
    </header>

    <div class="card">
      <div class="table-wrap">
        <table class="shiftboard" id="shiftTable">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="notice">
        表示軸：06:00 → 05:00（24列） / 日跨ぎシフトは最大2本に分割して表示
      </div>
      <div class="error" id="errorBox" style="display:none;"></div>
    </div>
  </div>

<script>
/* =============================
   設定（ここだけ自分のに！）
============================= */
// ✅ 1) Firebase config を自分のに置換
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
};

// ✅ 2) storeId（Firestore の stores/{storeId} のやつ）
const STORE_ID = "nambucho"; // 例：nambucho

/* =============================
   初期化
============================= */
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* =============================
   表示軸（6時始まり）
============================= */
const AXIS_START_HOUR = 6;
const AXIS_START = AXIS_START_HOUR * 60;   // 06:00 を 0 とする
const HOUR_COLS = DISPLAY_HOURS.length; // 24
const DISPLAY_HOURS = Array.from({length: 24}, (_,i)=> (AXIS_START_HOUR + i) % 24);

/* ===== 6時始まりの軸でバーを分割して返す ===== */
function toAxisMin(min) {
  return (min - AXIS_START + 1440) % 1440; // 0..1439
}

// start/end(通常の0..1439) → 6時軸での「セル範囲」に分割（最大2本）
function calcBarSegments(startMin, endMin) {
  if (startMin == null || endMin == null) return [];

  let e = endMin;

  // 日跨ぎ補正（22:00-05:00など）
  if (e <= startMin) e += 1440;

  // 6時軸へ変換
  let sA = toAxisMin(startMin);
  let eA = toAxisMin(e % 1440);

  // e が翌日側なら、軸上でも翌日扱い
  if (e > 1440 && eA <= sA) eA += 1440;
  if (eA <= sA) eA += 1440;

  const segs = [];
  if (eA <= 1440) {
    segs.push({ startIndex: Math.floor(sA / 60), endIndex: Math.ceil(eA / 60) });
  } else {
    segs.push({ startIndex: Math.floor(sA / 60), endIndex: 24 });
    segs.push({ startIndex: 0, endIndex: Math.ceil((eA - 1440) / 60) });
  }

  return segs
    .map(s => ({ startIndex: s.startIndex, span: Math.max(1, s.endIndex - s.startIndex) }))
    .filter(s => s.startIndex >= 0 && s.startIndex < 24 && s.span > 0);
}

/* =============================
   ユーティリティ
============================= */
function pad2(n){ return String(n).padStart(2,"0"); }

function parseHHMM(str) {
  if (!str) return null;
  const m = String(str).trim().match(/^(\d{1,2}):(\d{2})$/);
  if (!m) return null;
  const h = Number(m[1]), mi = Number(m[2]);
  if (Number.isNaN(h) || Number.isNaN(mi)) return null;
  return ((h % 24) * 60 + (mi % 60));
}

// YYYY-MM-DD（JST）で週の月曜を取る
function getMonday(d) {
  const date = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const day = (date.getDay() + 6) % 7; // Mon=0
  date.setDate(date.getDate() - day);
  return date;
}
function addDays(d, n) {
  const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  x.setDate(x.getDate() + n);
  return x;
}
function toYMD(d) {
  const y = d.getFullYear();
  const m = pad2(d.getMonth()+1);
  const da = pad2(d.getDate());
  return `${y}-${m}-${da}`;
}
function jpDow(d) {
  return ["日","月","火","水","木","金","土"][d.getDay()];
}

/* =============================
   データ取得（柔軟に吸収）
   Firestore 例：
   stores/{storeId}/shifts/{YYYY-MM-DD}
   1) { members:[{name,start,end}, ...] }
   2) { staff:[{name,start,end}, ...] }
   3) { shifts:[{name,start,end}, ...] }
============================= */
function normalizeMembers(data) {
  const arr =
    (Array.isArray(data?.members) && data.members) ||
    (Array.isArray(data?.staff) && data.staff) ||
    (Array.isArray(data?.shifts) && data.shifts) ||
    [];

  return arr.map(x => ({
    name: x?.name || x?.staffName || "スタッフ",
    start: x?.start || x?.startTime || x?.from || "",
    end: x?.end || x?.endTime || x?.to || "",
  })).filter(x => x.start && x.end);
}

async function fetchWeekShifts(mondayDate) {
  const days = Array.from({length: 7}, (_,i)=> addDays(mondayDate, i));
  const ymds = days.map(toYMD);

  // shifts コレクション想定
  const col = db.collection("stores").doc(STORE_ID).collection("shifts");

  // 7日分まとめて取得
  const snaps = await Promise.all(ymds.map(id => col.doc(id).get().catch(()=>null)));

  const map = {};
  snaps.forEach((snap, idx) => {
    const ymd = ymds[idx];
    if (!snap || !snap.exists) {
      map[ymd] = [];
      return;
    }
    const data = snap.data() || {};
    map[ymd] = normalizeMembers(data);
  });

  return { days, ymds, map };
}

/* =============================
   描画
============================= */
function renderHeader() {
  const thead = document.getElementById("thead");
  thead.innerHTML = "";
  const tr = document.createElement("tr");

  const th0 = document.createElement("th");
  th0.className = "shiftboard-day";
  th0.textContent = "日付";
  tr.appendChild(th0);

  DISPLAY_HOURS.forEach(h => {
    const th = document.createElement("th");
    th.textContent = `${pad2(h)}時`;
    tr.appendChild(th);
  });

  thead.appendChild(tr);
}

function renderBoard(week) {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  week.days.forEach((day, idx) => {
    const ymd = week.ymds[idx];
    const members = week.map[ymd] || [];

    // その日1行（複数スタッフは縦に行追加）
    if (!members.length) {
      const tr = document.createElement("tr");
      const tdDay = document.createElement("td");
      tdDay.className = "shiftboard-day";
      tdDay.innerHTML = `${ymd}<small>${jpDow(day)}</small>`;
      tr.appendChild(tdDay);

      // 全部空き
      const tdEmpty = document.createElement("td");
      tdEmpty.className = "shiftboard-empty";
      tdEmpty.colSpan = TOTAL_COLS;
      tr.appendChild(tdEmpty);

      tbody.appendChild(tr);
      return;
    }

    members.forEach((m, mIndex) => {
      const tr = document.createElement("tr");

      // 日付セル（最初のスタッフ行だけ表示、他は空にするならここで調整）
      const tdDay = document.createElement("td");
      tdDay.className = "shiftboard-day";
      if (mIndex === 0) {
        tdDay.innerHTML = `${ymd}<small>${jpDow(day)}</small>`;
      } else {
        tdDay.innerHTML = `<small style="opacity:.0">.</small>`;
      }
      tr.appendChild(tdDay);

      const startMin = parseHHMM(m.start);
      const endMin   = parseHHMM(m.end);

      // ★分割セグメント計算
      const segments = calcBarSegments(startMin, endMin);

      // segments を startIndex順で描画（最大2本）
      const segs = (segments || []).slice().sort((a,b)=>a.startIndex-b.startIndex);

      let cursor = 0;
      segs.forEach((seg, sidx) => {
        const before = Math.max(0, seg.startIndex - cursor);
        const barSpan = Math.max(1, seg.span);

        if (before > 0) {
          const tdBefore = document.createElement("td");
          tdBefore.className = "shiftboard-empty";
          tdBefore.colSpan = before;
          tr.appendChild(tdBefore);
          cursor += before;
        }

        const tdBar = document.createElement("td");
        tdBar.className = "shiftboard-bar-cell";
        tdBar.colSpan = barSpan;

        const barDiv = document.createElement("div");
        barDiv.className = "shiftboard-bar";

        const nameSpan = document.createElement("span");
        nameSpan.className = "shiftboard-bar-name";
        nameSpan.textContent = m.name || "スタッフ";

        const timeSpan = document.createElement("span");
        timeSpan.className = "shiftboard-bar-time";
        timeSpan.textContent = `${m.start}〜${m.end}`;

        // ✅ もし「2本目は名前いらん」ならここだけ一瞬で変えられる：
        // if (sidx === 1) nameSpan.textContent = "";
        // if (sidx === 1) timeSpan.textContent = ""; などもOK

        barDiv.appendChild(nameSpan);
        barDiv.appendChild(timeSpan);
        tdBar.appendChild(barDiv);
        tr.appendChild(tdBar);

        cursor += barSpan;
      });

      // 残りの空きを埋める
      const after = Math.max(0, TOTAL_COLS - cursor);
      if (after > 0) {
        const tdAfter = document.createElement("td");
        tdAfter.className = "shiftboard-empty";
        tdAfter.colSpan = after;
        tr.appendChild(tdAfter);
      }

      tbody.appendChild(tr);
    });
  });
}

/* =============================
   週ナビ
============================= */
let currentMonday = getMonday(new Date());

function setWeekLabel() {
  const from = toYMD(currentMonday);
  const to = toYMD(addDays(currentMonday, 6));
  document.getElementById("weekLabel").textContent = `${from} 〜 ${to}`;
}

function setMeta(text) {
  document.getElementById("metaText").textContent = text;
}
function showError(err) {
  const box = document.getElementById("errorBox");
  box.style.display = "block";
  box.textContent = String(err?.stack || err || "");
}
function clearError() {
  const box = document.getElementById("errorBox");
  box.style.display = "none";
  box.textContent = "";
}

async function reload() {
  clearError();
  setMeta("読み込み中...");
  setWeekLabel();
  renderHeader();

  try {
    const week = await fetchWeekShifts(currentMonday);
    renderBoard(week);
    setMeta(`storeId: ${STORE_ID} / ${toYMD(currentMonday)}週`);
  } catch (e) {
    showError(e);
    setMeta("読み込み失敗");
  }
}

document.getElementById("prevBtn").addEventListener("click", () => {
  currentMonday = addDays(currentMonday, -7);
  reload();
});
document.getElementById("nextBtn").addEventListener("click", () => {
  currentMonday = addDays(currentMonday, 7);
  reload();
});
document.getElementById("thisBtn").addEventListener("click", () => {
  currentMonday = getMonday(new Date());
  reload();
});

reload();
</script>

</body>
</html>
