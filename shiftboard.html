<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>シフト表（スタッフ用）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #111;
      line-height: 1.6;
      font-size: 14px;
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 12px 40px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    header h1 {
      font-size: 18px;
      font-weight: 700;
    }

    .meta {
      font-size: 12px;
      color: #666;
    }

    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .controls input[type="date"] {
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
    }

    .controls button {
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      background: #111;
      color: #fff;
      font-size: 12px;
      cursor: pointer;
    }

    .controls button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .card {
      background: #fff;
      border-radius: 6px;
      border: 1px solid #2e7d32;
      padding: 8px;
      overflow-x: auto;
    }

    /* ============================
       週別シフト（紙の予定表っぽく）
       ============================ */

    .shift-week-table {
      width: 100%;
      min-width: 950px;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 11px;
      background: #fff;
    }

    .shift-week-table th,
    .shift-week-table td {
      border: 1px solid #b9d8b9;
      padding: 2px 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .shift-week-table thead th {
      background: #f5fff5;
      color: #215c2f;
      font-weight: 600;
      text-align: center;
      border-bottom: 2px solid #2e7d32;
    }

    /* 日付列 */
    .shift-week-table td.col-date {
      width: 80px;
      text-align: center;
      background: #f5fff5;
      font-weight: 600;
    }

    /* 曜日列 */
    .shift-week-table td.col-weekday {
      width: 40px;
      text-align: center;
      background: #f5fff5;
      font-weight: 600;
    }

    /* 土日カラー */
    .is-sat {
      color: #1565c0;
    }
    .is-sun {
      color: #c62828;
    }

    /* 各時間帯マス */
    .slot-cell {
      vertical-align: top;
      padding: 2px 3px;
      font-size: 10px;
      line-height: 1.3;
    }

    .slot-cell.has-shift {
      background: #e8f5e9;
    }

    .slot-cell-empty {
      color: #bbb;
      text-align: center;
    }

    .slot-names {
      display: block;
      white-space: normal;
    }

    .notice {
      margin-top: 8px;
      font-size: 11px;
      color: #666;
    }

    .error {
      margin-top: 8px;
      font-size: 12px;
      color: #b00020;
    }

    @media (max-width: 640px) {
      header h1 {
        font-size: 16px;
      }
      .app {
        padding-inline: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>シフト表</h1>
        <div class="meta" id="storeLabel"></div>
      </div>
      <div class="meta" id="weekLabel"></div>
    </header>

    <div class="controls">
      <label>
        週の開始日：
        <input type="date" id="weekStartInput" />
      </label>
      <button id="reloadBtn">読み込み</button>
    </div>

    <div class="card" id="tableCard" style="display:none;">
      <!-- ★ 1行＝1日 / 列＝時間帯 -->
      <table class="shift-week-table">
        <thead>
          <tr id="theadRow">
            <!-- 日付 / 曜日 / 時間帯 をJSで -->
          </tr>
        </thead>
        <tbody id="tbody">
          <!-- 7日分の行をJSで -->
        </tbody>
      </table>
      <div class="notice">
        ※ オーナー画面「シフト作成（手動）」で保存した内容が表示されます。
      </div>
    </div>

    <div class="error" id="errorBox" style="display:none;"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // =============================
    // Firebase 設定
    // =============================
    const firebaseConfig = {
      apiKey: "AIzaSyAPBMvTpzKCcPxLETncBqVR8fzf0cqKirc",
      authDomain: "lawson-workflow.firebaseapp.com",
      projectId: "lawson-workflow",
      storageBucket: "lawson-workflow.firebasestorage.app",
      messagingSenderId: "335371795694",
      appId: "1:335371795694:web:3b0950a616d368b284c7ff",
      measurementId: "G-BGENZNZMRC"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // =============================
    // ユーティリティ
    // =============================
    function getQueryParam(name) {
      const params = new URLSearchParams(location.search);
      return params.get(name) || "";
    }

    function addDays(iso, add) {
      const d = new Date(iso);
      d.setDate(d.getDate() + add);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function formatDateLabelShort(iso) {
      const d = new Date(iso);
      if (isNaN(d.getTime())) return iso;
      const m = d.getMonth() + 1;
      const day = d.getDate();
      return `${m}/${day}`;
    }

    function getWeekdayLabel(d) {
      const w = d.getDay();
      const labels = ["日","月","火","水","木","金","土"];
      return labels[w] || "";
    }

    function timeStrToMin(str) {
      if (!str) return null;
      const [h, m] = str.split(":").map(n => parseInt(n, 10));
      if (Number.isNaN(h) || Number.isNaN(m)) return null;
      return h * 60 + m;
    }

    function rangeOverlap(aStart, aEnd, bStart, bEnd) {
      return aStart < bEnd && bStart < aEnd;
    }

    // 3時間ごとの時間帯（紙のやつっぽく）
    const TIME_SLOTS = [
      { label: "0-3",  startMin:   0, endMin: 180 },
      { label: "3-6",  startMin: 180, endMin: 360 },
      { label: "6-9",  startMin: 360, endMin: 540 },
      { label: "9-12", startMin: 540, endMin: 720 },
      { label: "12-15",startMin: 720, endMin: 900 },
      { label: "15-18",startMin: 900, endMin:1080 },
      { label: "18-21",startMin:1080, endMin:1260 },
      { label: "21-24",startMin:1260, endMin:1440 }
    ];

    // =============================
    // メイン処理
    // =============================
    document.addEventListener("DOMContentLoaded", () => {
      const storeId = getQueryParam("store");
      const storeLabel = document.getElementById("storeLabel");
      const weekLabel = document.getElementById("weekLabel");
      const weekStartInput = document.getElementById("weekStartInput");
      const reloadBtn = document.getElementById("reloadBtn");
      const errorBox = document.getElementById("errorBox");
      const tableCard = document.getElementById("tableCard");
      const theadRow = document.getElementById("theadRow");
      const tbody = document.getElementById("tbody");

      if (!storeId) {
        errorBox.style.display = "block";
        errorBox.textContent = "URLに ?store=店舗ID を付けてアクセスしてください。";
        reloadBtn.disabled = true;
        return;
      }

      storeLabel.textContent = `店舗ID: ${storeId}`;

      // 初期値：今日を含む週の月曜日
      const today = new Date();
      const dow = today.getDay(); // 0=日
      const diffToMon = (dow + 6) % 7; // 月=0
      today.setDate(today.getDate() - diffToMon);
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, "0");
      const d = String(today.getDate()).padStart(2, "0");
      const defaultWeek = `${y}-${m}-${d}`;
      weekStartInput.value = defaultWeek;

      reloadBtn.addEventListener("click", () => {
        const weekStart = weekStartInput.value;
        if (!weekStart) {
          alert("週の開始日を選択してください。");
          return;
        }
        loadWeek(storeId, weekStart);
      });

      async function loadWeek(storeId, weekStart) {
        errorBox.style.display = "none";
        tableCard.style.display = "none";
        reloadBtn.disabled = true;
        reloadBtn.textContent = "読み込み中…";

        try {
          const docSnap = await db
            .collection("stores")
            .doc(storeId)
            .collection("shiftWeeks")
            .doc(weekStart)
            .get();

          if (!docSnap.exists) {
            throw new Error("この週のシフトはまだ登録されていません。");
          }

          const data = docSnap.data() || {};
          renderTable(data, weekStart);
        } catch (err) {
          console.error(err);
          errorBox.style.display = "block";
          errorBox.textContent = err.message || "シフトの読み込みに失敗しました。";
        } finally {
          reloadBtn.disabled = false;
          reloadBtn.textContent = "読み込み";
        }
      }

      function renderTable(data, weekStart) {
        const members = data.members || [];
        if (!members.length) {
          throw new Error("この週のシフトデータにスタッフが登録されていません。");
        }

        // ---- ヘッダー：日付 / 曜日 / 時間帯 ----
        theadRow.innerHTML = "";

        const thDate = document.createElement("th");
        thDate.textContent = "日付";
        theadRow.appendChild(thDate);

        const thWeekday = document.createElement("th");
        thWeekday.textContent = "曜";
        theadRow.appendChild(thWeekday);

        TIME_SLOTS.forEach(slot => {
          const th = document.createElement("th");
          th.textContent = slot.label;
          theadRow.appendChild(th);
        });

        // 週ラベル
        const firstIso = addDays(weekStart, 0);
        const lastIso  = addDays(weekStart, 6);
        weekLabel.textContent =
          `${formatDateLabelShort(firstIso)}〜${formatDateLabelShort(lastIso)}`;

        // ---- 本体：7日分の行 ----
        tbody.innerHTML = "";

        for (let i = 0; i < 7; i++) {
          const dayIso = addDays(weekStart, i);
          const dObj = new Date(dayIso);
          const weekday = getWeekdayLabel(dObj);
          const w = dObj.getDay();

          const tr = document.createElement("tr");

          // 日付
          const tdDate = document.createElement("td");
          tdDate.className = "col-date";
          tdDate.textContent = formatDateLabelShort(dayIso);
          if (w === 6) tdDate.classList.add("is-sat");
          if (w === 0) tdDate.classList.add("is-sun");
          tr.appendChild(tdDate);

          // 曜日
          const tdWeek = document.createElement("td");
          tdWeek.className = "col-weekday";
          tdWeek.textContent = weekday;
          if (w === 6) tdWeek.classList.add("is-sat");
          if (w === 0) tdWeek.classList.add("is-sun");
          tr.appendChild(tdWeek);

          // 各時間帯マス
          TIME_SLOTS.forEach(slot => {
            const td = document.createElement("td");
            td.className = "slot-cell";

            const names = [];

            members.forEach(m => {
              const dayInfo =
                (m.days && m.days[dayIso]) ||
                (m.days && m.days[dayIso.replace(/-/g, "/")]) ||
                null;

              if (!dayInfo || !dayInfo.start || !dayInfo.end) return;

              const startMin = timeStrToMin(dayInfo.start);
              const endMin   = timeStrToMin(dayInfo.end);
              if (startMin == null || endMin == null || endMin <= startMin) return;

              if (rangeOverlap(startMin, endMin, slot.startMin, slot.endMin)) {
                names.push(m.name || "スタッフ");
              }
            });

            if (names.length) {
              td.classList.add("has-shift");
              const span = document.createElement("span");
              span.className = "slot-names";
              span.innerHTML = names.join("<br>");
              td.appendChild(span);
            } else {
              const span = document.createElement("span");
              span.className = "slot-cell-empty";
              span.textContent = "ーー";
              td.appendChild(span);
            }

            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        }

        tableCard.style.display = "block";
      }

      // 初回自動読み込み
      loadWeek(storeId, weekStartInput.value);
    });
  </script>
</body>
</html>

